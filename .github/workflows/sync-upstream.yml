name: Sync Upstream PRs

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Specific PR number to sync (optional)'
        required: false
        type: string

env:
  UPSTREAM_REPO: ionic-team/capacitor
  UPSTREAM_BRANCH: main

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "Capacitor+ Bot"
          git config user.email "bot@capgo.app"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git fetch upstream

      - name: Sync main branch from upstream
        run: |
          git checkout plus
          git fetch upstream main

          # Check if there are new commits from upstream
          UPSTREAM_COMMITS=$(git rev-list plus..upstream/main --count)

          if [ "$UPSTREAM_COMMITS" -gt 0 ]; then
            echo "Found $UPSTREAM_COMMITS new commits from upstream"
            echo "UPSTREAM_COMMITS=$UPSTREAM_COMMITS" >> $GITHUB_ENV
            echo "HAS_UPDATES=true" >> $GITHUB_ENV
          else
            echo "No new commits from upstream"
            echo "HAS_UPDATES=false" >> $GITHUB_ENV
          fi

      - name: Create sync branch and PR
        if: env.HAS_UPDATES == 'true'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # Generate branch name with date
          SYNC_BRANCH="sync/upstream-$(date +%Y%m%d-%H%M%S)"
          echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV

          # Create sync branch from plus
          git checkout -b "$SYNC_BRANCH" plus

          # Merge upstream changes
          git merge upstream/main --no-edit -m "chore: sync with upstream ionic-team/capacitor" || {
            echo "Merge conflicts detected"
            echo "HAS_CONFLICTS=true" >> $GITHUB_ENV
            git merge --abort
            exit 0
          }

          # Push the branch
          git push origin "$SYNC_BRANCH"

          # Create PR
          PR_BODY=$(cat <<'EOF'
          ## Automated Upstream Sync

          This PR syncs changes from the official [ionic-team/capacitor](https://github.com/ionic-team/capacitor) repository.

          ### Changes included:
          - Latest commits from upstream main branch

          ### Automation:
          - CI will run automatically
          - If all checks pass, this PR will be auto-merged
          - A new release will be published automatically

          ---
          *This PR was created automatically by the Capacitor+ sync workflow*
          EOF
          )

          gh pr create \
            --base plus \
            --head "$SYNC_BRANCH" \
            --title "chore: sync with upstream capacitor $(date +%Y-%m-%d)" \
            --body "$PR_BODY" \
            --label "upstream-sync,automated"

      - name: Handle merge conflicts
        if: env.HAS_CONFLICTS == 'true'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # Create an issue for manual resolution
          gh issue create \
            --title "Manual intervention required: Upstream sync conflicts $(date +%Y-%m-%d)" \
            --body "The automated upstream sync encountered merge conflicts. Please resolve them manually." \
            --label "upstream-sync,needs-attention"

  sync-specific-pr:
    if: github.event.inputs.pr_number != ''
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "Capacitor+ Bot"
          git config user.email "bot@capgo.app"

      - name: Fetch and create PR from upstream PR
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          PR_NUMBER: ${{ github.event.inputs.pr_number }}
        run: |
          # Fetch the PR
          git fetch https://github.com/${{ env.UPSTREAM_REPO }}.git pull/$PR_NUMBER/head:upstream-pr-$PR_NUMBER

          # Create branch for this PR
          SYNC_BRANCH="sync/upstream-pr-$PR_NUMBER"
          git checkout -b "$SYNC_BRANCH" plus

          # Cherry-pick or merge the PR commits
          git merge upstream-pr-$PR_NUMBER --no-edit -m "chore: sync upstream PR #$PR_NUMBER" || {
            echo "Merge conflicts detected for PR #$PR_NUMBER"
            git merge --abort

            gh issue create \
              --title "Manual intervention required: Upstream PR #$PR_NUMBER sync conflicts" \
              --body "The sync of upstream PR #$PR_NUMBER encountered merge conflicts. Please resolve them manually." \
              --label "upstream-sync,needs-attention"
            exit 0
          }

          # Push and create PR
          git push origin "$SYNC_BRANCH"

          # Get upstream PR info
          UPSTREAM_PR_TITLE=$(gh pr view $PR_NUMBER --repo ${{ env.UPSTREAM_REPO }} --json title -q '.title')
          UPSTREAM_PR_URL="https://github.com/${{ env.UPSTREAM_REPO }}/pull/$PR_NUMBER"

          gh pr create \
            --base plus \
            --head "$SYNC_BRANCH" \
            --title "chore: sync upstream PR #$PR_NUMBER - $UPSTREAM_PR_TITLE" \
            --body "Syncing upstream PR: $UPSTREAM_PR_URL" \
            --label "upstream-sync,automated"
